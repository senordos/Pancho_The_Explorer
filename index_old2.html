<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pancho the Explorer</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #ffffff; display: block; margin: 0 auto; }
    </style>
</head>
<body>
<section id="fullscreen">
<canvas id="myCanvas" width="1024" height="768"></canvas>
</section>
<script src="leveldata.js"></script>
<script>




var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

//ctx.scale(0.75,0.75);

var touchable = 'createTouch' in document;
if(touchable) 
{
	canvas.addEventListener( 'touchstart', onTouchStart, false );
	canvas.addEventListener( 'touchmove', onTouchMove, false );
	canvas.addEventListener( 'touchend', onTouchEnd, false );



}
var touches = [];
var t = 0;


var pps = 500; //pixels movement per second
var dx = 2;
var dy = -2;

var framerate;
var timeindex=0;
var counter=0;
var lastTimeIndex=0;
var gameFrame=0;
var gameTimeInFrame=0;
var gamePaused=false;
var levelComplete=false;

ctx.font = "30px Arial";

const PADDLEWIDTH=5;
const PADDLEHEIGHT=30;
const PADDLEMOVEMENT=3;
const PADDLESTARTXGAP=20;
const PLAYERJUMP= -28;

const GRAVITY = 2.5;

var paddle1_X=PADDLESTARTXGAP;
var paddle1_Y=canvas.height/2;

var paddle2_X=canvas.width-PADDLESTARTXGAP-PADDLEWIDTH;
var paddle2_Y=canvas.height/2;

var mapOffsetX = 0;
var mapOffsetY = 0;

var player1_UpPressed=false;
var player1_DownPressed=false;
var player1_LeftPressed=false;
var player1_RightPressed=false;

var player2_UpPressed=false;
var player2_DownPressed=false;

var bricks = [];

var compareRect = [];

const CANVASWIDTH = canvas.width;
const CANVASHEIGHT = canvas.height;
const BALLRADIUS = 5;
const BALLDIAMETER = BALLRADIUS * 2;

const ANIMATIONSPEED = 125;

//to build bricks to shape the level
const BRICKCOLS = 60;
const BRICKROWS = 40;
const BRICKCOUNT = BRICKROWS * BRICKCOLS;
const BRICKHEIGHT = 64;
const BRICKWIDTH = 64;
const BRICKSTARTX = 0;
const BRICKSTARTY = 0;


//game debug variables
var showTargetRect = false;


tiles = new Image();
tiles.src = "tiles/platform_tiles.png";


var enemy_image = new Image();
var player_image = new Image();

var player1;
var enemies = [];


var touch = { x:0, y:0, type:"NONE", id:0 };

var touchButtons = {  left:{pressed:false, touchId:-1},
                      right:{pressed:false, touchId:-1},
                      up:{pressed:false, touchId:-1},
                    }


var sprite = { x: 64, y: 64, h: 64, w: 64, targetX: 128, targetY: 512,
                name:"GENERAL SPRITE", 
                img:"NO_IMAGE", 
                animFrame:0,
                xDirection:1,
                yDirection:1,
                xSpeed:0, 
                ySpeed:0,
                //for collision detection, these rectangles define the player
                rectMain:{top:0,bottom:0,left:0,right:0},
                rectOffset:{top:0,bottom:63,left:0,right:63},
                rectTopOffset:{top:0,bottom:19,left:7,right:55},
                rectBottomOffset:{top:43,bottom:63,left:8,right:56},
                rectLeftOffset:{top:19,bottom:43,left:0,right:19},
                rectRightOffset:{top:19,bottom:43,left:43,right:63},
                collisionWidth:56,
                collisionHeight:64,
                collisionTop:false, 
                collisionBottom:false, 
                collisionLeft:false, 
                collisionRight:false,

                collisionExit:false,
                collisionDeath:false,

                alive:true, 
                deadly:true,
                hit:false, //sprite is hit by something
                jump:false,

                getCollisionRect:function()
                {
                    var collisionRect = {
                          top: this.rectOffset.top + this.targetY,
                          bottom: this.rectOffset.bottom + this.targetY,
                          left: this.rectOffset.left + this.targetX,
                          right: this.rectOffset.right + this.targetX
                    };

                    return  collisionRect;
                },

                getBottomCollisionRect:function()
                {
                    var bottomCollisionRect = {
                          top: this.rectBottomOffset.top + this.targetY,
                          bottom: this.rectBottomOffset.bottom + this.targetY,
                          left: this.rectBottomOffset.left + this.targetX,
                          right: this.rectBottomOffset.right + this.targetX
                    };

                    return  bottomCollisionRect;
                },
                getTopCollisionRect:function()
                {
                    var topCollisionRect = {
                          top: this.rectTopOffset.top + this.targetY,
                          bottom: this.rectTopOffset.bottom + this.targetY,
                          left: this.rectTopOffset.left + this.targetX,
                          right: this.rectTopOffset.right + this.targetX
                    };

                    return  topCollisionRect;
                },    

                update:function()
                {
                    
                    if (this.collision.xOverlap !=0) 
                    { 
                                                        this.x = this.x - this.collision.xOverlap;
                                                        this.collision.xOverlap = 0;
                    }
                    if (this.collision.yOverlap !=0) 
                    { 
                                                        this.y = this.y - this.collision.yOverlap;
                                                        this.collision.yOverlap = 0;
                    }
                    this.rectMain.top = this.rectOffset.top + this.y;// - this.collision.yOverlap;
                    this.rectMain.bottom = this.rectOffset.bottom + this.y;// - this.collision.yOverlap;
                    this.rectMain.left = this.rectOffset.left + this.x; // - this.collision.xOverlap;
                    this.rectMain.right = this.rectOffset.right + this.x; // - this.collision.xOverlap;

                }

              }; 


function setAttributes(elem, obj) 
{
    for (var prop in obj) 
    {
        if (obj.hasOwnProperty(prop)) 
        {
            elem[prop] = obj[prop];
        }
    }
}





function initBricks(){
    
    var i = 0; //array counter
    var a = 0; //array x
    var b = 0; //array y
    var x = 0; //target brick x
    var y = 0; //target brick y
    var p = 0; //Position in the level array
    var c = 0; //the colour of the brick    
    var rectMain; //to be the collision rectangle
    var tileName;



    for (var l=0; l < levels[0].layers.length; l++)
    {
        if (levels[0].layers[l].name == "Map")
        {
            level1 = levels[0].layers[l].data;    
        }

        if (levels[0].layers[l].name == "Objects")
        {
            var enemyCounter = 0;

            for (var o=0; o < levels[0].layers[l].objects.length; o++)
            {

                if (levels[0].layers[l].objects[o].name == "Player")
                {
                    player1 = Object.create(sprite);
                    setAttributes(player1, { 
                        name:"Player 1", 
                        img:"tiles/spritesheet_player.png",
                        rectOffset:{top:0,bottom:63,left:8,right:55}
                        });
                        
                }
                if (levels[0].layers[l].objects[o].name == "Enemy1")
                {
                    enemies[enemyCounter] = Object.create(sprite);
                    setAttributes(enemies[enemyCounter], { 
                        name:"Enemy 1", 
                        img:"tiles/spritesheet_enemy1.png",                         
                        x:384, 
                        y:128,
                        xSpeed:1,
                        rectOffset:{top:16,bottom:63,left:8,right:55}
                    
                    });

                    enemies[enemyCounter].x = levels[0].layers[l].objects[o].x; 
                    enemies[enemyCounter].y = levels[0].layers[l].objects[o].y; 

                    enemyCounter++;
                    console.log(enemyCounter);
                }
            }    
        }
    }
     
    level1 = levels[0].layers[0].data;    



    //set the brick positions 
    for (b=0; b < BRICKROWS; b++){
      for (a=0; a < BRICKCOLS; a++){
          
          p = b * BRICKCOLS + a;    

          x = BRICKSTARTX + (a * BRICKWIDTH);
          y = BRICKSTARTY + (b * BRICKHEIGHT);
          
          switch(level1[i])
          {
                      
            case 1:  tileName="rock1";   rectMain = {top:y+16, bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:0};   deadly = false; exit=false; break;
            case 2:  tileName="exit1";   rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:64};  deadly = false; exit=true;  break;
            case 3:  tileName="exit2";   rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:128}; deadly = false; exit=true;  break;
            case 4:  tileName="dirt1";   rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:192}; deadly = false; exit=false; break;
            case 5:  tileName="brick1";  rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:256}; deadly = false; exit=false; break;
            case 6:  tileName="spikes1"; rectMain = {top:y+24, bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:320}; deadly = true;  exit=false; break;
            case 7:  tileName="stone2";  rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:384}; deadly = false; exit=false; break;
            case 8:  tileName="stone3";  rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:448}; deadly = false; exit=false; break;
            case 9:  tileName="stone4";  rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:512}; deadly = false; exit=false; break;
            case 10: tileName="stone4";  rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:576}; deadly = false; exit=false; break;
            default: tileName="none";    rectMain = {top:y,    bottom:y+63, left:x, right:x+63}; spritesheetPos = {x:0,y:0};   deadly = false; exit=false; break;

          }
          


          bricks[i] = { 
                x: x, 
                y: y, 
                colour: level1[p], 
                rectMain: rectMain,
                tileName: tileName,
                spritesheetPos: spritesheetPos,
                deadly: deadly,
                exit: exit,
          };
          i++;
      }
    }
}





function intersectRect(r1, r2) 
{
  
  return !(r2.left > r1.right || 
           r2.right < r1.left || 
           r2.top > r1.bottom ||
           r2.bottom < r1.top);
}




function checkWorldCollisions(sprite)
{

    //Checks a sprite's targetX and targetY positions for collisions

    //First, reset the sprite's collision array
    //As this will be called separately for X and Y movement, this needs to be reset separately
    if(sprite.targetX != sprite.x)
    {
        //moving in X axis
        sprite.collisionLeft = false;
        sprite.collisionRight = false;
    }

    if(sprite.targetY != sprite.y)
    {
        //moving in Y axis
        sprite.collisionTop = false;
        sprite.collisionBottom = false;
    }
    


    spriteTargetRect=sprite.getCollisionRect();

    if (showTargetRect)
    {
          ctx.beginPath();
          ctx.rect( spriteTargetRect.left, 
                    spriteTargetRect.top,
                    spriteTargetRect.right - spriteTargetRect.left,
                    spriteTargetRect.bottom - spriteTargetRect.top);

          ctx.fillStyle = "#fffaaa";
          ctx.fill();
          ctx.closePath();

    }
        


    var i = 0;
    for (i=0; i < BRICKCOUNT; i++)
    {
        if(bricks[i].colour > 0)
        {
            if (intersectRect(spriteTargetRect, bricks[i].rectMain))
            {

   
                if(sprite.targetX > sprite.x)
                {
                    //All sprites are animated from the top left corner, so need to add the width when moving right
                    sprite.targetX = bricks[i].rectMain.left - sprite.collisionWidth;
                    
                }
                else if(sprite.targetX < sprite.x)
                {
                    //the player is moving left

                    //All sprites are animated from the top left corner, so brick right + 1 is correct
                    sprite.targetX = bricks[i].rectMain.right - 7;

                }
           
                if(sprite.targetY > sprite.y)
                {
                    //if the y target is higher - so moving down

                    //All sprites are animated from the top left corner, so need to add the hight when moving down
                    sprite.targetY = bricks[i].rectMain.top - sprite.collisionHeight;

                    //If moving down, the collision must be below, so set collision parameter
                    sprite.collisionBottom = true;

                }

                else if(sprite.targetY < sprite.y)
                {
                    //the player is moving up 
                   
                    //All sprites are animated from the top left corner, so brick bottom + 1 is correct
                    sprite.targetY = bricks[i].rectMain.bottom + 1;

                    sprite.collisionTop = true;
                } 

                if(bricks[i].exit == true)
                {
                    sprite.collisionExit = true;
                    console.log("Collision - Exit");
                }          
                else if (bricks[i].deadly == true)
                {
                    sprite.collisionDeath = true;
                    console.log("Collision - deadly tile: " + bricks[i].tileName);
                }

                return true;
            }
           
        }
       
    }

    return false;
}


function checkEnemyCollisions(playerSprite)
{
    
    //when looping through all the sprites, use "name" to check the sprite being checked isn't "this" sprites

    //get the Rect for this sprite
        //Build a rectangle based on the overall sprite's collision offset
    var playerRect = playerSprite.getCollisionRect();

    for (i=0; i < enemies.length; i++)
    {
        var enemyRect = enemies[i].getCollisionRect();

        if(intersectRect(playerRect, enemyRect) && enemies[i].deadly == true)
        {
            console.log("hit enemy!");
            var playerBottomRect = playerSprite.getBottomCollisionRect();

            var enemyTopRect = enemies[i].getTopCollisionRect();

            if(intersectRect(playerBottomRect, enemyTopRect) && enemies[i].hit == false)
            {
                //player on top of enemy

                enemies[i].hit = true;
                enemies[i].deadly = false;
                enemies[i].xSpeed = 3;
                enemies[i].xDirection = enemies[i].xDirection * -1;

                playerSprite.yDirection = PLAYERJUMP - 4;;

            }
            else
            {
                //player hit by enemy
                playerSprite.hit = true;

            }
        }
    }
}





function movePlayerX()
{

    //reset the player targets before moving.
    player1.targetX = player1.x;
    player1.targetY = player1.y;


    


    if(player1_LeftPressed)
    {
        player1.xSpeed = player1.xSpeed - 0.1;
        if (player1.xSpeed < -1) { player1.xSpeed = -1; }
        player1.xDirection = -1;
    }
    else if(player1_RightPressed)
    {
        player1.xSpeed = player1.xSpeed + 0.1;
        if (player1.xSpeed > 1) { player1.xSpeed = 1; }
        player1.xDirection = 1;
    }
    else
    {
        //player needs to slow down and stop
        if (player1.xSpeed > 0)
        {
            player1.xSpeed = player1.xSpeed -0.1;
            //due to rounding issues in binary 
            if (player1.xSpeed > 0 && player1.xSpeed < 0.1) {player1.xSpeed = 0};
        }
        else if (player1.xSpeed < 0)
        {
            player1.xSpeed = player1.xSpeed +0.1;
            //due to rounding issues in binary 
            if (player1.xSpeed < 0 && player1.xSpeed > -0.1) {player1.xSpeed = 0};
        }
    }
    player1.targetX = player1.x + (pixelmove * player1.xSpeed);

    checkWorldCollisions(player1);
    player1.x = player1.targetX;

   // console.log(player1.xSpeed);

}

function movePlayerY()
{


    //reset the player targets before moving.
    player1.targetX = player1.x;
    player1.targetY = player1.y;

    if(player1_UpPressed && player1.collisionBottom)
    {
      player1.yDirection = PLAYERJUMP; 
      player1.targetY = player1.y + player1.yDirection;
    }
    else
    {
        player1.yDirection = player1.yDirection + GRAVITY;
        if (player1.yDirection > 20) {player1.yDirection = 20;}
        player1.targetY = player1.y + player1.yDirection;
    }

    if (checkWorldCollisions(player1))
    {
        player1.yDirection = 0;
    }
    player1.y = player1.targetY;

}


function moveEnemiesY()
{

    for(i=0; i < enemies.length; i++)
    {
        //reset the enemy targets before moving.
        enemies[i].targetX = enemies[i].x;
        enemies[i].targetY = enemies[i].y;


        //enemies fall due to gravity
        enemies[i].yDirection = enemies[i].yDirection + GRAVITY;

        if (enemies[i].yDirection > 5) {enemies[i].yDirection = 5;}

        enemies[i].targetY = enemies[i].y + enemies[i].yDirection;


        if (checkWorldCollisions(enemies[i]))
        {
            enemies[i].yDirection = 0;
        }

        enemies[i].y = enemies[i].targetY;
    }
}

function moveEnemiesX()
{
    for(i=0; i < enemies.length; i++)
    {
        //reset the player targets before moving.
        enemies[i].targetY = enemies[i].y;


        enemies[i].targetX = enemies[i].x + ((enemies[i].xDirection * 2) * enemies[i].xSpeed); //2 here should be related to pixelmove, but it isn't

        if ( checkWorldCollisions(enemies[i]) )
        {
            enemies[i].xDirection = enemies[i].xDirection * -1;
        }

        enemies[i].x = enemies[i].targetX;
    }
}


function drawBricks(){

    var image;

    if (player1.x - mapOffsetX > 576) { mapOffsetX = player1.x - 576; }
    if (player1.x - mapOffsetX < 320) { mapOffsetX = player1.x - 320; }
    if (mapOffsetX < 0) { mapOffsetX = 0; }
    if (player1.y - mapOffsetY > 448) { mapOffsetY = player1.y - 448; }
    if (player1.y - mapOffsetY < 256) { mapOffsetY = player1.y - 256; }
    if (mapOffsetY < 0) { mapOffsetY = 0; }




    for (i=0; i < BRICKCOUNT; i++){
        if(bricks[i].colour != 0){

            if (bricks[i].tileName != "none")
            {
               ctx.drawImage(tiles, bricks[i].spritesheetPos.x, bricks[i].spritesheetPos.y, 64, 64, bricks[i].x - mapOffsetX, bricks[i].y - mapOffsetY, 64, 64);
            }
        }

    }

}

function drawRect(rect, sprite, colour)
{
      ctx.beginPath();
      ctx.rect( sprite.x + rect.left, 
                sprite.y + rect.top,
                rect.right - rect.left,
                rect.bottom - rect.top);

      ctx.fillStyle = colour;
      ctx.fill();
      ctx.closePath();
}

function drawPlayer() 
{
   var animXOffset = 0;
   var animYOffset = 0;

    if(player1.xDirection == -1)
    {
        animYOffset = 64;
    }
    else if(player1.xDirection == 1)
    {
        animYOffset = 0;
    }


   if(player1_LeftPressed)
   {
        animYOffset = 64;
        //animXOffset = player1.animFrame=gameFrame * 64;
        animXOffset = (gameFrame % 5) * 64;
   }

   if(player1_RightPressed)
   {
        animYOffset = 0;
        //animXOffset = player1.animFrame=gameFrame * 64;
        animXOffset = (gameFrame % 5) * 64;
   }

   player_image.src = player1.img;
   ctx.drawImage(player_image, animXOffset,animYOffset,64,64, player1.x - mapOffsetX, player1.y - mapOffsetY,64,64);
}


function drawEnemies() 
{

   for(i=0; i < enemies.length; i++)
   {
       var animXOffset = 0;
       var animYOffset = 0;

       if (enemies[i].hit == true)
       {
           animYOffset = 64;
       }

       //sets position in the spritesheet 
       //the 4 is because there are only 4 animations in the enemy 
       animXOffset = (gameFrame % 4) * 64;

       enemy_image.src = enemies[i].img;  

      // drawRect(enemies[i].rectLeftOffset, enemies[i], "#fffaaa");
       //drawRect(enemies[i].rectTopOffset, enemies[i], "#fffccc");

       ctx.drawImage(enemy_image, animXOffset,animYOffset,64,64, enemies[i].x - mapOffsetX, enemies[i].y - mapOffsetY,64,64);
   }
}

function drawControls()
{
    controls = new Image();
    controls.src = "tiles/spritesheet_controls.png";
    ctx.drawImage(controls,   0, 0, 64, 64, 32,  672, 64, 64);
    ctx.drawImage(controls,  64, 0, 64, 64, 128, 672, 64, 64);
    ctx.drawImage(controls, 128, 0, 64, 64, 928, 672, 64, 64);


}


function calculateFrameRate() {
    var d = new Date();
    var n = d.getTime();

    counter++;

    if ((n - timeindex) > 1000){
  
      framerate = counter;
      counter=0;
      timeindex = n;
        
    }
    ctx.fillStyle = "#000000";

    ctx.fillText(framerate,10,50);
   
}



function gameLoop() 
{

    if (!gamePaused && !levelComplete)
    { 
        var date = new Date();
        var loopTimeIndex = date.getTime();

        loopTimeGap = loopTimeIndex - lastTimeIndex;
        lastTimeIndex = loopTimeIndex;

        gameTimeInFrame = gameTimeInFrame + loopTimeGap;

        if(gameTimeInFrame > ANIMATIONSPEED) 
        {
            gameTimeInFrame = 0; 
            gameFrame = gameFrame + 1;
            if (gameFrame > 19) 
            {  
                gameFrame=0;
            }
        }



        //can optimise this and only erase and redraw the parts which change.
        ctx.clearRect(0, 0, canvas.width, canvas.height);



        pixelmove = Math.trunc(pps * (loopTimeGap / 1000)); 
                ctx.fillStyle = "#ffffff";

        ctx.fillText(Math.round(pixelmove),75,50);

        if (pixelmove > 10)
        {
            ctx.fillStyle = "#ffffff";
            ctx.fillText("Frame rate dropped below normal game operation!",150,50);
        }



        drawBricks();
        moveEnemiesX();

        moveEnemiesY();



        movePlayerX();
        movePlayerY();

        checkEnemyCollisions(player1);

        if (player1.collisionExit == true)
        {
            alert("Level Complete!");
            levelComplete = true;
        }

        drawEnemies();
        drawPlayer();
        if (true) { drawControls(); }


        calculateFrameRate();


        if (player1.hit) 
        { 
            gamePaused = true;
            alert("Game Over!!! - The enemy got you!"); 
        }
        else if (player1.collisionDeath == true)
        {
            gamePaused = true;
            alert("Game Over!!! - You need to be more careful where you stand!"); 
        }

    
       


    }
    
}


document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);

function keyDownHandler(e) 
{
    switch(e.keyCode)
    {
      case 37: player1_LeftPressed = true; break;
      case 38: player1_UpPressed = true; break;
      case 39: player1_RightPressed = true; break;
      case 40: player1_DownPressed = true; break;

    }
}

function keyUpHandler(e) 
{
    switch(e.keyCode)
    {
      case 37: player1_LeftPressed = false; break;
      case 38: player1_UpPressed = false; break;
      case 39: player1_RightPressed = false; break;
      case 40: player1_DownPressed = false; break;
      case 84: if (showTargetRect == false) {showTargetRect=true;} else {showTargetRect=false;}; break;
      case 80: if (gamePaused == false) { gamePaused = true;} else {gamePaused=false;}; break;
    }
}

function onTouchStart(event) {
	//do stuff
    var x;
    var y;
    var id;

    var iMax = event.changedTouches.length;


    for(var i=0; i<iMax; i++)
    { 

        x = event.changedTouches[i].clientX;
        y = event.changedTouches[i].clientY;
        id = event.changedTouches[i].identifier;


        if (x>16 &&  x<112)   { touchButtons.left.pressed = true; touchButtons.left.touchId = id } 
        if (x>112 &&  x<224)  { touchButtons.right.pressed = true; touchButtons.right.touchId = id } 
        if (x>912 &&  x<1008) { touchButtons.up.pressed = true; touchButtons.up.touchId = id } 

    }


    if (touchButtons.left.pressed == true) { player1_LeftPressed = true; } else { player1_LeftPressed = false; }
    if (touchButtons.right.pressed == true) { player1_RightPressed = true; } else { player1_RightPressed = false; }
    if (touchButtons.up.pressed == true) { player1_UpPressed = true; } else { player1_UpPressed = false; }

}
 
function onTouchMove(event) {
	 // Prevent the browser from doing its default thing (scroll, zoom)
	event.preventDefault(); 

    var id; 

    var iMax = event.changedTouches.length;

    for(var i=0; i<iMax; i++)
    { 
        x = event.changedTouches[i].clientX;
        y = event.changedTouches[i].clientY;
        id = event.changedTouches[i].identifier;
        
        if ( touchButtons.left.touchId == id ) { touchButtons.left.pressed = false; }
        if ( touchButtons.right.touchId == id ) { touchButtons.right.pressed = false; }
        if ( touchButtons.up.touchId == id ) { /* do nothing - even if moves off the up button */ }

        if (x>16 &&  x<112)   { touchButtons.left.pressed = true; touchButtons.left.touchId = id } 
        if (x>112 &&  x<224)  { touchButtons.right.pressed = true; touchButtons.right.touchId = id } 

    }

    if (touchButtons.left.pressed == true) { player1_LeftPressed = true; } else { player1_LeftPressed = false; }
    if (touchButtons.right.pressed == true) { player1_RightPressed = true; } else { player1_RightPressed = false; }
    if (touchButtons.up.pressed == true) { player1_UpPressed = true; } else { player1_UpPressed = false; }


} 
 
function onTouchEnd(event) { 

    var id; 

    var iMax = event.changedTouches.length;

    for(var i=0; i<iMax; i++)
    { 
        id = event.changedTouches[i].identifier;

        if ( touchButtons.left.touchId == id ) { touchButtons.left.pressed = false; }
        if ( touchButtons.right.touchId == id ) { touchButtons.right.pressed = false; }
        if ( touchButtons.up.touchId == id ) { touchButtons.up.pressed = false; }

    }

    if (touchButtons.left.pressed == true) { player1_LeftPressed = true; } else { player1_LeftPressed = false; }
    if (touchButtons.right.pressed == true) { player1_RightPressed = true; } else { player1_RightPressed = false; }
    if (touchButtons.up.pressed == true) { player1_UpPressed = true; } else { player1_UpPressed = false; }

}



initBricks();
setInterval(gameLoop, 20);
 


</script>

</body>
</html>