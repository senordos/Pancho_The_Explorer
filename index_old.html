<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Platform</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #ffffff; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="960" height="640"></canvas>

<script>

var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

var pps = 250; //pixels movement per second
var dx = 2;
var dy = -2;

var framerate;
var timeindex=0;
var counter=0;
var lastTimeIndex=0;
var gameFrame=0;
var gameTimeInFrame=0;

ctx.font = "30px Arial";

const PADDLEWIDTH=5;
const PADDLEHEIGHT=30;
const PADDLEMOVEMENT=3;
const PADDLESTARTXGAP=20;

const GRAVITY = 4;

var paddle1_X=PADDLESTARTXGAP;
var paddle1_Y=canvas.height/2;

var paddle2_X=canvas.width-PADDLESTARTXGAP-PADDLEWIDTH;
var paddle2_Y=canvas.height/2;

var player1_UpPressed=false;
var player1_DownPressed=false;
var player1_LeftPressed=false;
var player1_RightPressed=false;

var player2_UpPressed=false;
var player2_DownPressed=false;

var bricks = [];

var compareRect = [];

const CANVASWIDTH = canvas.width;
const CANVASHEIGHT = canvas.height;
const BALLRADIUS = 5;
const BALLDIAMETER = BALLRADIUS * 2;

const ANIMATIONSPEED = 125;

//to build bricks to shape the level
const BRICKCOLS = 15;
const BRICKROWS = 10;
const BRICKCOUNT = BRICKROWS * BRICKCOLS;
const BRICKHEIGHT = 64;
const BRICKWIDTH = 64;
const BRICKSTARTX = 0;
const BRICKSTARTY = 0;

var brick1 = new Image();
brick1.src = "tiles/ground.png";

var rock1 = new Image();
rock1.src = "tiles/rock.png";

var player1 = { x: 128, y: 512, h: 64, w: 64, 
                name:"player1", 
                img:"tiles/spritesheet_player.png", 
                animFrame:0, 
                yDirection:0,
                rectMain:{top: this.y,bottom: this.y+63,left: this.x, right: this.x+63}, //same as start x / y
                rectOffset:{top:0,bottom:63,left:0,right:63},
                rectTopOffset:{top:0,bottom:9,left:0,right:63},
                rectBottomOffset:{top:53,bottom:63,left:0,right:63},
                rectLeftOffset:{top:10,bottom:52,left:0,right:31},
                rectRightOffset:{top:10,bottom:52,left:32,right:63},
                collision:{top:false, bottom:false, left:false, right:false,
                           xOverlap:0, yOverlap:0},
                update:function()
                {
                    
                    if (this.collision.xOverlap !=0) 
                    { 
                                                        this.x = this.x - this.collision.xOverlap;
                                                        this.collision.xOverlap = 0;
                    }
                    if (this.collision.yOverlap !=0) 
                    { 
                                                        this.y = this.y - this.collision.yOverlap;
                                                        this.collision.yOverlap = 0;
                    }
                    this.rectMain.top = this.rectOffset.top + this.y;// - this.collision.yOverlap;
                    this.rectMain.bottom = this.rectOffset.bottom + this.y;// - this.collision.yOverlap;
                    this.rectMain.left = this.rectOffset.left + this.x; // - this.collision.xOverlap;
                    this.rectMain.right = this.rectOffset.right + this.x; // - this.collision.xOverlap;

                },
                resetCollision:function()
                {
           
                    this.collision = {top:false, bottom:false, left:false, right:false,
                           xOverlap:0, yOverlap:0};
                }

              }; 


var player1_img = new Image();
player1_img.src = player1["img"];

function initBricks(){
    
    var i = 0; //array counter
    var a = 0; //array x
    var b = 0; //array y
    var x = 0; //target brick x
    var y = 0; //target brick y
    var p = 0; //Position in the level array
    var c = 0; //the colour of the brick
    

    var level1 = [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                  0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                  0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,
                  3,0,0,0,0,0,0,0,0,0,0,0,0,0,3,
                  1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];

    //set the brick positions 
    for (b=0; b < BRICKROWS; b++){
      for (a=0; a < BRICKCOLS; a++){
          p = b * BRICKCOLS + a;    
          

          x = BRICKSTARTX + (a * BRICKWIDTH);
          y = BRICKSTARTY + (b * BRICKHEIGHT);
          bricks[i] = { x: x, y: y , colour: level1[p], rectMain:{top:y, bottom:y+64, left:x, right:x+64}};
          i++;
      }
    }
}





function intersectRect(r1, r2) 
{
  
  return !(r2.left > r1.right || 
           r2.right < r1.left || 
           r2.top > r1.bottom ||
           r2.bottom < r1.top);
}

function checkCollisions()
{
    player1.resetCollision();

    //Check ball collisions with bricks
    var i = 0;
    for (i=0; i < BRICKCOUNT; i++)
    {
        if(bricks[i].colour > 0)
        {
            if (intersectRect(bricks[i].rectMain, player1.rectMain))
            {
                  compareRect={top:bricks[i].rectMain.top - player1.y,
                                 bottom: bricks[i].rectMain.bottom - player1.y,
                                 left: bricks[i].rectMain.left - player1.x,
                                 right: bricks[i].rectMain.right - player1.x,
                                 };

                  ctx.beginPath();
                  ctx.rect(compareRect.left, compareRect.top,64,64);
                  ctx.fillStyle = "#fffaab";
                  ctx.fill();
                  ctx.closePath();

                if (intersectRect( compareRect, player1.rectTopOffset ))
                {
                    player1.collision.top = true;
                    player1.update();

                }
                if (intersectRect( compareRect, player1.rectBottomOffset ))
                {
                    player1.collision.bottom = true;
                    player1.collision.yOverlap = player1.rectMain.bottom - bricks[i].rectMain.top;
                    player1.update();

                }
                if (intersectRect( compareRect, player1.rectLeftOffset ))
                {
                    player1.collision.left = true;
                    player1.collision.xOverlap = player1.rectMain.left - bricks[i].rectMain.right;
                    player1.update();

                }
                if (intersectRect( compareRect, player1.rectRightOffset ))
                {
                    player1.collision.right = true;
                    player1.collision.xOverlap = player1.rectMain.right - bricks[i].rectMain.left;
                    player1.update();
                }

            }
        }
    }

}

function drawBricks(){

    for (i=0; i < BRICKCOUNT; i++){
        if(bricks[i].colour != 0){

          
          switch(bricks[i].colour)
          {


            case 1:
              ctx.drawImage(brick1,bricks[i].x,bricks[i].y);
              break;

            case 2:
              ctx.beginPath();
              ctx.rect(bricks[i].x,bricks[i].y, BRICKWIDTH, BRICKHEIGHT);
              ctx.fillStyle = "#0095DD";
              ctx.fill();
              ctx.closePath();
              break;

            case 3:
              ctx.drawImage(rock1,bricks[i].x,bricks[i].y);
              break;

            default:
              ctx.beginPath();
              ctx.rect(bricks[i].x,bricks[i].y, BRICKWIDTH, BRICKHEIGHT);
              ctx.fillStyle = "#ffffff";
              ctx.fill();
              ctx.closePath();
          }

          ctx.fill();
          ctx.closePath();
        }

    }

}

function drawPlayer() 
{
   var animXOffset = 0;
   var animYOffset = 0;

   if(player1_LeftPressed)
   {
        animYOffset = 64;
        animXOffset = player1.animFrame=gameFrame * 64;
   }

   if(player1_RightPressed)
   {
        animYOffset = 0;
        animXOffset = player1.animFrame=gameFrame * 64;
   }

  //Draw collision box around player
  ///*
  ctx.beginPath();
  ctx.rect(player1.rectMain.left, player1.rectMain.top,64,64);
  ctx.fillStyle = "#fffaaa";
  ctx.fill();
  ctx.closePath();
  //*/


   ctx.drawImage(player1_img, animXOffset,animYOffset,64,64, player1.x, player1.y,64,64);
}

function movePlayerX()
{

    if(player1_LeftPressed)
    {
      player1.x = player1.x - pixelmove;
      //player1.update();

    }

    if(player1_RightPressed)
    {
      player1.x = player1.x + pixelmove;
      //player1.update();
    }



    player1.update();
}

function movePlayerY()
{


    if(player1_UpPressed && player1.collision.bottom)
    {
      player1.yDirection = -96;  
      player1.y = player1.y + player1.yDirection;

      //player1.update();
    }

    if (player1.collision.bottom)
    {
        player1.yDirection = 0;

    }
    else
    {
        player1.yDirection = player1.yDirection + GRAVITY;
        player1.y = player1.y + player1.yDirection;
        player1.update();
    }

    player1.update();
}



function calculateFrameRate() {
    var d = new Date();
    var n = d.getTime();

    counter++;

    if ((n - timeindex) > 1000){
  
      framerate = counter;
      counter=0;
      timeindex = n;
        
    }
    ctx.fillStyle = "#ffffff";

    ctx.fillText(framerate,10,50);
   
}



function draw() {

    var date = new Date();
    var loopTimeIndex = date.getTime();

    loopTimeGap = loopTimeIndex - lastTimeIndex;
    lastTimeIndex = loopTimeIndex;

    gameTimeInFrame = gameTimeInFrame + loopTimeGap;

    if(gameTimeInFrame > ANIMATIONSPEED) 
    {
        gameTimeInFrame = 0; 
        gameFrame = gameFrame + 1;
        if (gameFrame > 5) 
        {  
            gameFrame=0;
        }
    }


    ctx.clearRect(0, 0, canvas.width, canvas.height);


    drawBricks();
    movePlayerY();
    checkCollisions();
    movePlayerX();
    checkCollisions();


    drawPlayer();


    calculateFrameRate();

    pixelmove = pps * (loopTimeGap / 1000); 
            ctx.fillStyle = "#ffffff";

    ctx.fillText(Math.round(pixelmove),75,50);

    if (pixelmove > 10)
    {
        ctx.fillStyle = "#ffffff";
        ctx.fillText("Frame rate dropped below normal game operation!",150,50);
    }

}


document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);

function keyDownHandler(e) 
{
    switch(e.keyCode)
    {
      case 37: player1_LeftPressed = true; break;
      case 38: player1_UpPressed = true; break;
      case 39: player1_RightPressed = true; break;
      case 40: player1_DownPressed = true; break;

    }
}

function keyUpHandler(e) 
{
    switch(e.keyCode)
    {
      case 37: player1_LeftPressed = false; break;
      case 38: player1_UpPressed = false; break;
      case 39: player1_RightPressed = false; break;
      case 40: player1_DownPressed = false; break;
    }
}



initBricks();
setInterval(draw, 35);
 


</script>

</body>
</html>